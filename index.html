// Updated Log out function
window.logOut = async function (auto = false) {
    try {
        if (autoLogoutTimer) {
            clearTimeout(autoLogoutTimer);
            autoLogoutTimer = null;
        }

        if (currentUser) {
            // Get the current email list to find the key
            const dbRef = ref(db);
            const snapshot = await get(child(dbRef, 'email'));
            
            if (snapshot.exists()) {
                const emailData = snapshot.val();
                console.log("Current email data:", emailData);
                
                // Find the key that contains the current user's email
                let keyToDelete = null;
                for (const [key, email] of Object.entries(emailData)) {
                    if (email === currentUser.email) {
                        keyToDelete = key;
                        break;
                    }
                }
                
                if (keyToDelete) {
                    console.log("Deleting key:", keyToDelete);
                    const emailRef = ref(db, `email/${keyToDelete}`);
                    await remove(emailRef);
                    console.log("Email removed successfully");
                } else {
                    console.log("Email not found in database");
                }
            }
        }

        await signOut(auth);
        currentUser = null;

        document.getElementById("maincont").style.visibility = "hidden";
        document.getElementById("butto").style.display = "inline-block";
        document.getElementById("logoutBtn").style.display = "none";

        alert(auto ? "Session expired. You have been logged out." : "Logged out successfully.");
    } catch (error) {
        console.error("Logout error:", error);
        alert("Error signing out.");
    }
};
